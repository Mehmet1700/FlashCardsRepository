<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Flashcards</title>
<style>
:root{--pad:16px;--radius:16px;--border:#e5e7eb}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;color:#0b1220}
.header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:8px var(--pad);display:flex;gap:8px;align-items:center;z-index:10}
.header h1{font-size:18px;margin:0;font-weight:700;flex:1}
.btn{padding:10px 12px;border:1px solid #ccc;border-radius:12px;background:#fff;cursor:pointer}
.btn.primary{border-color:#111;background:#111;color:#fff}
.container{max-width:900px;margin:0 auto;padding:var(--pad)}
.card{border:1px solid var(--border);border-radius:var(--radius);padding:24px;box-shadow:0 1px 8px rgba(0,0,0,.05);margin-top:16px}
.front{font-size:1.4rem;font-weight:700}
.back{font-size:1.15rem;margin-top:12px;display:none}
.row{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
.row .btn{flex:1}
.muted{color:#6b7280;font-size:.9rem;margin-top:6px}
.tabs{display:flex;gap:8px}
.tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
.tab.active{background:#111;color:#fff;border-color:#111}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
input[type="text"], input[type="search"], textarea{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px}
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th,.table td{border-bottom:1px solid var(--border);padding:10px;text-align:left;vertical-align:top}
.table td.actions{width:130px}
.badge{display:inline-block;padding:2px 8px;border:1px solid #d1d5db;border-radius:999px;font-size:.8rem;margin-right:6px;color:#374151}
@media (min-width:700px){.row .btn{flex:unset}}
</style>

<body>
  <div class="header">
    <h1>Flashcards</h1>
    <button id="tab-study" class="tab active">Study</button>
    <button id="tab-manage" class="tab">Manage</button>
    <button id="btn-token" class="btn">Admin Token</button>
  </div>

  <div class="container">
    <div id="stats" class="muted">Loadingâ€¦</div>

    <!-- Study view -->
    <div id="view-study">
      <div id="study-card" class="card" hidden>
        <div id="front" class="front"></div>
        <div id="back" class="back"></div>
        <div class="row">
          <button id="show"  class="btn">Show</button>
          <button id="again" class="btn" hidden>Again</button>
          <button id="good"  class="btn primary" hidden>Good</button>
          <button id="easy"  class="btn" hidden>Easy</button>
        </div>
      </div>
    </div>

    <!-- Manage view -->
    <div id="view-manage" hidden>
      <div class="card">
        <div class="toolbar">
          <input id="search" type="search" placeholder="Search front/back/tagsâ€¦">
          <button id="btn-add" class="btn">Add New</button>
        </div>
        <div class="muted">Edits & deletes require admin token (stored locally in your browser).</div>
        <table class="table" id="table">
          <thead>
            <tr><th>Front</th><th>Back</th><th>Tags</th><th class="actions">Actions</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const API = '/api/cards';
let TOKEN = localStorage.getItem('fc_token') || '';
let cards=[], queue=[];

// ----- helpers -----
const el = (id) => document.getElementById(id);
function authHeaders() {
  return TOKEN ? { 'Authorization': 'Bearer '+TOKEN } : {};
}
function due(c){ return !c.next_review || new Date(c.next_review) <= new Date(); }
function renderStats(){ el('stats').textContent = `${queue.filter(due).length} due / ${cards.length} total`; }
function sanitize(s){ return String(s ?? '').replace(/^=+\\s*/, '').trim(); }
function tagstr(t){ return (Array.isArray(t)?t:[]).join(', '); }

// ----- tabs -----
function setTab(name){
  const study = name==='study';
  el('view-study').hidden = !study;
  el('view-manage').hidden = study;
  el('tab-study').classList.toggle('active', study);
  el('tab-manage').classList.toggle('active', !study);
}
el('tab-study').onclick = ()=>setTab('study');
el('tab-manage').onclick = ()=>{ setTab('manage'); drawTable(); };

el('btn-token').onclick = async ()=>{
  const t = prompt('Enter admin WRITE_TOKEN (saved locally). Leave empty to clear.', TOKEN || '');
  if (t===null) return;
  TOKEN = (t||'').trim();
  if (TOKEN) localStorage.setItem('fc_token', TOKEN);
  else localStorage.removeItem('fc_token');
  alert(TOKEN ? 'Token saved âœ…' : 'Token cleared.');
};

// ----- load & study -----
async function load(){
  try {
    const r = await fetch(API, {cache:'no-store'});
    if (!r.ok) throw new Error(`HTTP \${r.status}`);
    const d = await r.json();
    cards = d.cards || [];
    queue = cards.slice().sort((a,b) => new Date(a.next_review||0)-new Date(b.next_review||0));
    renderStats();
    next();
  } catch (e) {
    el('stats').textContent = `Error loading cards: \${e.message}`;
    el('stats').style.color = 'red';
    console.error(e);
  }
}

function next(){
  const wrap = el('study-card');
  if(queue.filter(due).length===0){ wrap.hidden=true; el('stats').textContent='All done ðŸŽ‰'; return; }
  wrap.hidden=false;
  const c = queue.find(due);
  el('front').textContent = c.front;
  const back = el('back'); back.textContent = c.back; back.style.display='none';

  el('show').hidden=false; el('again').hidden=true; el('good').hidden=true; el('easy').hidden=true;

  el('show').onclick = ()=>{ back.style.display='block'; el('show').hidden=true; el('again').hidden=false; el('good').hidden=false; el('easy').hidden=false; };
  el('again').onclick = ()=>answer(c,'again');
  el('good').onclick  = ()=>answer(c,'good');
  el('easy').onclick  = ()=>answer(c,'easy');
}

function schedule(card, rating){
  const now=new Date();
  const ease=Math.max(1.3,(card.ease||2.5)+(rating==='easy'?+0.15:rating==='again'?-0.2:0));
  let iv=card.interval||0;
  if(rating==='again'){ iv=0.01; } else if(iv===0){ iv=1; } else { iv=Math.round(iv*ease); }
  const next=new Date(now.getTime()+iv*86400000);
  Object.assign(card,{ease,interval:iv,next_review:next.toISOString()});
}

async function answer(c, rating){
  schedule(c, rating);
  // fire-and-forget persistence if token set
  if (TOKEN) {
    fetch(API, {
      method:'POST',
      headers:{'Content-Type':'application/json', ...authHeaders()},
      body: JSON.stringify(c)
    }).catch(()=>{});
  }
  // rotate queue
  queue = queue.filter(x=>x.id!==c.id).concat([c]);
  renderStats();
  next();
}

// ----- manage table -----
el('search').addEventListener('input', drawTable);

function filtered(){
  const q = el('search').value.toLowerCase();
  if(!q) return cards;
  return cards.filter(c =>
    (c.front||'').toLowerCase().includes(q) ||
    (c.back||'').toLowerCase().includes(q) ||
    tagstr(c.tags).toLowerCase().includes(q)
  );
}

function drawTable(){
  const tb = el('tbody');
  tb.innerHTML = '';
  for (const c of filtered()){
    const tr = document.createElement('tr');
    tr.innerHTML = \`
      <td><input data-k="front"  data-id="\${c.id}" value="\${c.front?.replace(/"/g,'&quot;')||''}" /></td>
      <td><textarea data-k="back" data-id="\${c.id}">\${c.back||''}</textarea></td>
      <td><input data-k="tags"   data-id="\${c.id}" value="\${(c.tags||[]).join(', ')}" /></td>
      <td class="actions">
        <button class="btn" data-act="save" data-id="\${c.id}">Save</button>
        <button class="btn" data-act="del"  data-id="\${c.id}">Delete</button>
      </td>\`;
    tb.appendChild(tr);
  }

  tb.querySelectorAll('button[data-act="save"]').forEach(b=>b.onclick = ()=>saveRow(b.dataset.id));
  tb.querySelectorAll('button[data-act="del"]').forEach(b=>b.onclick  = ()=>delRow(b.dataset.id));
}

async function saveRow(id){
  if(!TOKEN){ alert('Set admin token first (top right).'); return; }
  const row = [...document.querySelectorAll('[data-id="'+id+'"]')].reduce((acc,el)=>{
    const k = el.getAttribute('data-k');
    if (!k) return acc;
    acc[k] = el.value;
    return acc;
  }, {});
  const patch = {
    front: sanitize(row.front),
    back:  sanitize(row.back),
    tags:  (row.tags||'').split(',').map(s=>s.trim()).filter(Boolean).slice(0,10)
  };
  const r = await fetch(API+'/'+encodeURIComponent(id), {
    method: 'PUT',
    headers: {'Content-Type':'application/json', ...authHeaders()},
    body: JSON.stringify(patch)
  });
  if(!r.ok){ alert('Update failed'); return; }
  await load();
  setTab('manage');
}

async function delRow(id){
  if(!TOKEN){ alert('Set admin token first.'); return; }
  if(!confirm('Delete this card?')) return;
  const r = await fetch(API+'/'+encodeURIComponent(id), { method:'DELETE', headers: authHeaders() });
  if(!r.ok){ alert('Delete failed'); return; }
  await load();
  setTab('manage');
}

el('btn-add').onclick = async ()=>{
  if(!TOKEN){ alert('Set admin token first.'); return; }
  const front = prompt('Front (question / PT):','');
  if(front===null) return;
  const back  = prompt('Back (answer / DE or EN):','');
  if(back===null) return;
  const r = await fetch(API, {
    method:'POST',
    headers:{'Content-Type':'application/json', ...authHeaders()},
    body: JSON.stringify({ front: sanitize(front), back: sanitize(back), tags:['manual'] })
  });
  if(!r.ok){ alert('Add failed'); return; }
  await load();
  setTab('manage');
};

// boot
load();
</script>
</body>
</html>
